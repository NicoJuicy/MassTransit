<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Custom | MassTransit</title>
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    
    
    <link rel="preload" href="/MassTransit/assets/css/0.styles.e9548384.css" as="style"><link rel="preload" href="/MassTransit/assets/js/app.507829b3.js" as="script"><link rel="preload" href="/MassTransit/assets/js/6.b9c46cbe.js" as="script"><link rel="preload" href="/MassTransit/assets/js/1.f2cfa088.js" as="script"><link rel="preload" href="/MassTransit/assets/js/26.08518995.js" as="script"><link rel="prefetch" href="/MassTransit/assets/js/10.8a53d3c6.js"><link rel="prefetch" href="/MassTransit/assets/js/100.dea5063d.js"><link rel="prefetch" href="/MassTransit/assets/js/101.fdf33797.js"><link rel="prefetch" href="/MassTransit/assets/js/102.08802a09.js"><link rel="prefetch" href="/MassTransit/assets/js/103.94dfe6b2.js"><link rel="prefetch" href="/MassTransit/assets/js/104.a2200f50.js"><link rel="prefetch" href="/MassTransit/assets/js/105.f38fb744.js"><link rel="prefetch" href="/MassTransit/assets/js/106.9f4944a0.js"><link rel="prefetch" href="/MassTransit/assets/js/107.29628318.js"><link rel="prefetch" href="/MassTransit/assets/js/108.dd7f1d58.js"><link rel="prefetch" href="/MassTransit/assets/js/109.876d62e4.js"><link rel="prefetch" href="/MassTransit/assets/js/11.489768a6.js"><link rel="prefetch" href="/MassTransit/assets/js/110.525aec89.js"><link rel="prefetch" href="/MassTransit/assets/js/111.5d7c6cef.js"><link rel="prefetch" href="/MassTransit/assets/js/12.c2c0c52b.js"><link rel="prefetch" href="/MassTransit/assets/js/13.de967d55.js"><link rel="prefetch" href="/MassTransit/assets/js/14.80f79d01.js"><link rel="prefetch" href="/MassTransit/assets/js/15.f0ec9a0d.js"><link rel="prefetch" href="/MassTransit/assets/js/16.07e33012.js"><link rel="prefetch" href="/MassTransit/assets/js/17.a5458ce9.js"><link rel="prefetch" href="/MassTransit/assets/js/18.d0709395.js"><link rel="prefetch" href="/MassTransit/assets/js/19.d6ea4de4.js"><link rel="prefetch" href="/MassTransit/assets/js/20.6f83da94.js"><link rel="prefetch" href="/MassTransit/assets/js/21.394a4a17.js"><link rel="prefetch" href="/MassTransit/assets/js/22.d356c42c.js"><link rel="prefetch" href="/MassTransit/assets/js/23.803d54aa.js"><link rel="prefetch" href="/MassTransit/assets/js/24.7926c825.js"><link rel="prefetch" href="/MassTransit/assets/js/25.53cfecab.js"><link rel="prefetch" href="/MassTransit/assets/js/27.c45a4e89.js"><link rel="prefetch" href="/MassTransit/assets/js/28.216d09b3.js"><link rel="prefetch" href="/MassTransit/assets/js/29.d80bacb6.js"><link rel="prefetch" href="/MassTransit/assets/js/30.cdc44409.js"><link rel="prefetch" href="/MassTransit/assets/js/31.f476159a.js"><link rel="prefetch" href="/MassTransit/assets/js/32.31b6eefe.js"><link rel="prefetch" href="/MassTransit/assets/js/33.79798b43.js"><link rel="prefetch" href="/MassTransit/assets/js/34.cc04befa.js"><link rel="prefetch" href="/MassTransit/assets/js/35.f29df75f.js"><link rel="prefetch" href="/MassTransit/assets/js/36.e9d6cc6d.js"><link rel="prefetch" href="/MassTransit/assets/js/37.dd12c8f5.js"><link rel="prefetch" href="/MassTransit/assets/js/38.31ac2f25.js"><link rel="prefetch" href="/MassTransit/assets/js/39.7124ee1f.js"><link rel="prefetch" href="/MassTransit/assets/js/4.6ac43b74.js"><link rel="prefetch" href="/MassTransit/assets/js/40.eefd40da.js"><link rel="prefetch" href="/MassTransit/assets/js/41.33aebd66.js"><link rel="prefetch" href="/MassTransit/assets/js/42.b885c43e.js"><link rel="prefetch" href="/MassTransit/assets/js/43.ebbd1e2a.js"><link rel="prefetch" href="/MassTransit/assets/js/44.f87ec852.js"><link rel="prefetch" href="/MassTransit/assets/js/45.53e426f0.js"><link rel="prefetch" href="/MassTransit/assets/js/46.21f60550.js"><link rel="prefetch" href="/MassTransit/assets/js/47.85684ee0.js"><link rel="prefetch" href="/MassTransit/assets/js/48.904c9b27.js"><link rel="prefetch" href="/MassTransit/assets/js/49.2ef354b5.js"><link rel="prefetch" href="/MassTransit/assets/js/5.413cd6be.js"><link rel="prefetch" href="/MassTransit/assets/js/50.54704214.js"><link rel="prefetch" href="/MassTransit/assets/js/51.4cc1c6f9.js"><link rel="prefetch" href="/MassTransit/assets/js/52.a945a897.js"><link rel="prefetch" href="/MassTransit/assets/js/53.2372d01e.js"><link rel="prefetch" href="/MassTransit/assets/js/54.d69d0b89.js"><link rel="prefetch" href="/MassTransit/assets/js/55.ee9680f6.js"><link rel="prefetch" href="/MassTransit/assets/js/56.ffd754c3.js"><link rel="prefetch" href="/MassTransit/assets/js/57.116a2a32.js"><link rel="prefetch" href="/MassTransit/assets/js/58.d3335fc9.js"><link rel="prefetch" href="/MassTransit/assets/js/59.7b8d567a.js"><link rel="prefetch" href="/MassTransit/assets/js/60.0e44b996.js"><link rel="prefetch" href="/MassTransit/assets/js/61.4e20793d.js"><link rel="prefetch" href="/MassTransit/assets/js/62.bcf0b140.js"><link rel="prefetch" href="/MassTransit/assets/js/63.52ae8ff6.js"><link rel="prefetch" href="/MassTransit/assets/js/64.819c10c7.js"><link rel="prefetch" href="/MassTransit/assets/js/65.3682be0f.js"><link rel="prefetch" href="/MassTransit/assets/js/66.5e442452.js"><link rel="prefetch" href="/MassTransit/assets/js/67.f0901a9e.js"><link rel="prefetch" href="/MassTransit/assets/js/68.edf45a54.js"><link rel="prefetch" href="/MassTransit/assets/js/69.0691d2ff.js"><link rel="prefetch" href="/MassTransit/assets/js/7.8a51af61.js"><link rel="prefetch" href="/MassTransit/assets/js/70.8e280419.js"><link rel="prefetch" href="/MassTransit/assets/js/71.d655551b.js"><link rel="prefetch" href="/MassTransit/assets/js/72.9f171999.js"><link rel="prefetch" href="/MassTransit/assets/js/73.38a47796.js"><link rel="prefetch" href="/MassTransit/assets/js/74.1753e133.js"><link rel="prefetch" href="/MassTransit/assets/js/75.28f9b3e6.js"><link rel="prefetch" href="/MassTransit/assets/js/76.6dbd3b9e.js"><link rel="prefetch" href="/MassTransit/assets/js/77.7e7a6a46.js"><link rel="prefetch" href="/MassTransit/assets/js/78.f603b82b.js"><link rel="prefetch" href="/MassTransit/assets/js/79.5cee3c98.js"><link rel="prefetch" href="/MassTransit/assets/js/8.6b741284.js"><link rel="prefetch" href="/MassTransit/assets/js/80.6aefc97d.js"><link rel="prefetch" href="/MassTransit/assets/js/81.dcaa7545.js"><link rel="prefetch" href="/MassTransit/assets/js/82.4f71f3b3.js"><link rel="prefetch" href="/MassTransit/assets/js/83.602dc14d.js"><link rel="prefetch" href="/MassTransit/assets/js/84.b2e3702c.js"><link rel="prefetch" href="/MassTransit/assets/js/85.55a4f6af.js"><link rel="prefetch" href="/MassTransit/assets/js/86.f75a06f2.js"><link rel="prefetch" href="/MassTransit/assets/js/87.efc02065.js"><link rel="prefetch" href="/MassTransit/assets/js/88.60fb1dd8.js"><link rel="prefetch" href="/MassTransit/assets/js/89.5dc2cfdb.js"><link rel="prefetch" href="/MassTransit/assets/js/9.9f129a0e.js"><link rel="prefetch" href="/MassTransit/assets/js/90.c3da6b52.js"><link rel="prefetch" href="/MassTransit/assets/js/91.4f25ae4d.js"><link rel="prefetch" href="/MassTransit/assets/js/92.ff3a8464.js"><link rel="prefetch" href="/MassTransit/assets/js/93.26d099c6.js"><link rel="prefetch" href="/MassTransit/assets/js/94.395a5fdd.js"><link rel="prefetch" href="/MassTransit/assets/js/95.885d64a6.js"><link rel="prefetch" href="/MassTransit/assets/js/96.438fc819.js"><link rel="prefetch" href="/MassTransit/assets/js/97.acde79bf.js"><link rel="prefetch" href="/MassTransit/assets/js/98.6add9580.js"><link rel="prefetch" href="/MassTransit/assets/js/99.d7afcafc.js"><link rel="prefetch" href="/MassTransit/assets/js/vuejs-paginate.55199f2c.js">
    <link rel="stylesheet" href="/MassTransit/assets/css/0.styles.e9548384.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MassTransit/" class="home-link router-link-active"><img src="/MassTransit/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/MassTransit/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/MassTransit/usage/" class="sidebar-heading clickable open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/MassTransit/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/MassTransit/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/MassTransit/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/MassTransit/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Advanced</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/MassTransit/advanced/scheduling/" class="sidebar-heading clickable"><span>Scheduling</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/MassTransit/advanced/courier/" class="sidebar-heading clickable"><span>Courier</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/MassTransit/advanced/middleware/" class="sidebar-heading clickable router-link-active open"><span>Middleware</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/advanced/middleware/receive.html" class="sidebar-link">Receive Pipeline</a></li><li><a href="/MassTransit/advanced/middleware/circuit-breaker.html" class="sidebar-link">Circuit Breaker</a></li><li><a href="/MassTransit/advanced/middleware/rate-limiter.html" class="sidebar-link">Rate Limiter</a></li><li><a href="/MassTransit/advanced/middleware/latest.html" class="sidebar-link">Latest</a></li><li><a href="/MassTransit/advanced/middleware/transactions.html" class="sidebar-link">Transaction</a></li><li><a href="/MassTransit/advanced/middleware/custom.html" class="active sidebar-link">Custom</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><a href="/MassTransit/usage/message-data.html" class="sidebar-link">Message Data</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>Monitoring</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/MassTransit/advanced/connect-endpoint.html" class="sidebar-link">Connect Endpoint</a></li><li><a href="/MassTransit/advanced/observers.html" class="sidebar-link">Observers</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/MassTransit/advanced/topology/" class="sidebar-heading clickable"><span>Topology</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/MassTransit/advanced/signalr/" class="sidebar-heading clickable"><span>SignalR</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/advanced/audit.html" class="sidebar-link">Message Audit</a></li><li><a href="/MassTransit/advanced/batching.html" class="sidebar-link">Batching</a></li><li><a href="/MassTransit/advanced/turnout/" class="sidebar-link">Turnout</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MassTransit/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="custom"><a href="#custom" class="header-anchor">#</a> Custom</h1> <p>Middleware components are configured using extension methods, to make them easy to discover.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>By default, a middleware configuration method should start with <code>Use</code>.</p></div> <p>An example middleware component that would log exceptions to the console is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingInMemory</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">UseExceptionLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The extension method creates the pipe specification for the middleware component, which can be added to any pipe. For a component on the message consumption pipeline, use <code>ConsumeContext</code> instead of any <code>PipeContext</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExampleMiddlewareConfiguratorExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token generic-method"><span class="token function">UseExceptionLogger</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span> IPipeConfigurator<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> configurator<span class="token punctuation">)</span>
        <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> PipeContext
    <span class="token punctuation">{</span>
        configurator<span class="token punctuation">.</span><span class="token function">AddPipeSpecification</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ExceptionLoggerSpecification</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The pipe specification is a class that adds the filter to the pipeline. Additional logic can be included, such as configuring optional settings, etc. using a closure syntax similar to the other configuration classes in MassTransit.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionLoggerSpecification</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">:</span>
    IPipeSpecification<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
    <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> PipeContext
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>ValidationResult<span class="token operator">&gt;</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token punctuation">&lt;</span><span class="token class-name">ValidationResult</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Apply</span><span class="token punctuation">(</span>IPipeBuilder<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">AddFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ExceptionLoggerFilter</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, the middleware component itself is a filter added to the pipeline. All filters have absolute and complete control of the execution context and flow of the message. Pipelines are entirely asynchronous, and expect that asynchronous operations will be performed.</p> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>Do not use legacy constructs such as .Wait, .Result, or .WaitAll() as these can cause blocking in the message pipeline. While they might work in same cases, you've been warned!</p></div> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionLoggerFilter</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">:</span>
    IFilter<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
    <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span><span class="token punctuation">,</span> PipeContext
<span class="token punctuation">{</span>
    <span class="token keyword">long</span> _exceptionCount<span class="token punctuation">;</span>
    <span class="token keyword">long</span> _successCount<span class="token punctuation">;</span>
    <span class="token keyword">long</span> _attemptCount<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> scope <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">CreateFilterScope</span><span class="token punctuation">(</span><span class="token string">&quot;exceptionLogger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;attempted&quot;</span><span class="token punctuation">,</span> _attemptCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;succeeded&quot;</span><span class="token punctuation">,</span> _successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scope<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;faulted&quot;</span><span class="token punctuation">,</span> _exceptionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Send is called for each context that is sent through the pipeline</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;context&quot;&gt;The context sent through the pipeline&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=&quot;next&quot;&gt;The next filter in the pipe, must be called or the pipe ends here&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">T</span> context<span class="token punctuation">,</span> IPipe<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> _attemptCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// here the next filter in the pipe is called</span>
            <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> _successCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> _exceptionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> Console<span class="token punctuation">.</span>Out<span class="token punctuation">.</span><span class="token function">WriteLineAsync</span><span class="token punctuation">(</span>$<span class="token string">&quot;An exception occurred: {ex.Message}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// propagate the exception up the call stack</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The example filter above is stateful. If the filter was stateless, the same filter instance could be used by multiple pipes — worth considering if the filter has high memory requirements.</p> <h3 id="message-type-filters"><a href="#message-type-filters" class="header-anchor">#</a> Message Type Filters</h3> <p>In many cases, the message type is used by a filter. To create an instance of a generic filter that includes the message type, use the configuration observer.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageFilterConfigurationObserver</span> <span class="token punctuation">:</span>
    <span class="token class-name">ConfigurationObserver</span><span class="token punctuation">,</span>
    IMessageConfigurationObserver
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MessageFilterConfigurationObserver</span><span class="token punctuation">(</span><span class="token class-name">IConsumePipeConfigurator</span> receiveEndpointConfigurator<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>receiveEndpointConfigurator<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token generic-method"><span class="token function">MessageConfigured</span><span class="token punctuation">&lt;</span><span class="token class-name">TMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">IConsumePipeConfigurator</span> configurator<span class="token punctuation">)</span>
        <span class="token keyword">where</span> TMessage <span class="token punctuation">:</span> <span class="token keyword">class</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> specification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">MessageFilterPipeSpecification</span><span class="token punctuation">&lt;</span><span class="token class-name">TMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        configurator<span class="token punctuation">.</span><span class="token function">AddPipeSpecification</span><span class="token punctuation">(</span>specification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then, in the specification, the appropriate filter can be created and added to the pipeline.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageFilterPipeSpecification</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">:</span>
    IPipeSpecification<span class="token operator">&lt;</span>ConsumeContext<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span>
    <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Apply</span><span class="token punctuation">(</span>IPipeBuilder<span class="token operator">&lt;</span>ConsumeContext<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">MessageFilter</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        builder<span class="token punctuation">.</span><span class="token function">AddFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>ValidationResult<span class="token operator">&gt;</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The filter could then include the message type as a generic type parameter.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageFilter</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token punctuation">:</span>
    IFilter<span class="token operator">&lt;</span>ConsumeContext<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span>
    <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>        
        <span class="token keyword">var</span> scope <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">CreateFilterScope</span><span class="token punctuation">(</span><span class="token string">&quot;messageFilter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Send</span><span class="token punctuation">(</span><span class="token class-name">T</span> context<span class="token punctuation">,</span> IPipe<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// do something</span>

        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The extension method for the above is shown below (for completeness).</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MessageFilterConfigurationExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">UseMessageFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IConsumePipeConfigurator</span> configurator<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configurator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>configurator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageFilterConfigurationObserver</span><span class="token punctuation">(</span>configurator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/advanced/middleware/custom.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/11/2019, 3:58:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MassTransit/advanced/middleware/transactions.html" class="prev">Transaction</a></span> <span class="next"><a href="/MassTransit/usage/message-data.html">Message Data</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MassTransit/assets/js/app.507829b3.js" defer></script><script src="/MassTransit/assets/js/6.b9c46cbe.js" defer></script><script src="/MassTransit/assets/js/1.f2cfa088.js" defer></script><script src="/MassTransit/assets/js/26.08518995.js" defer></script>
  </body>
</html>
